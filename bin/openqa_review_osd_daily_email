#!/bin/sh -e

. $(dirname $0)/_common
setup_tmpdir

recv="${recv:-"openqa-suse-status@suse.de"}"
html_target="${html_target:-"/suse/okurz/Export/openqa_suse_de_status.html"}"
openqa_review_args="${openqa_review_args:-"--host http://openqa.suse.de -n -r -T --query-issue-status --no-empty-sections --include-softfails --running-threshold=2 --exclude-job-groups ^(Released|Development) $@"}"
load_args="${load_args:-"--load --load-dir=${tmp}"}"
openqa_review_email_args="${openqa_review_email_args:-"${load_args}"}"
openqa_review_html_args="${openqa_review_html_args:-"${load_args} --report-links"}"
openqa_review_save_args="${openqa_review_save_args:-"--report-links --reminder-comment-on-issues --save --save-dir ${tmp}"}"
openqa_review_reminder_args="${openqa_review_reminder_args:-"${load_args} --reminder-comment-on-issues"}"
openqa_review="${openqa_review:-"$(which openqa-review)"}"
TPL="${TPL:-"dashboard_files/dashboard.html.in"}"
# the awk call is to ignore the "InsecureWarning" and the following blank line
# that is generated by accessing with requests on an https server for which we
# don't know the certificate, see http://unix.stackexchange.com/a/279620
# this is actually fixed in a more recent python3-requests but we don't have
# that yet. Anyway, we don't need certificates as we trust the internal server
# and as long as we don't want to authenticate manually against the UI it's ok
# to use the http:// URL
#save_report="$(${openqa_review} $openqa_review_args $openqa_review_save_args 2>&1| awk -v nlines=2 '/Insecure.*Warning/ {for (i=0; i<nlines; i++) {getline}; next} 1')"
save_report="$(${openqa_review} $openqa_review_args $openqa_review_save_args)"
email_report="$(${openqa_review} $openqa_review_args $openqa_review_email_args)"
(echo -e "This is an automated message generated by 'openqa-review', see https://github.com/okurz/openqa_review for details. An HTML version of this report is available on https://w3.nue.suse.com/~okurz/openqa_suse_de_status.html. Status of tests and builds on https://openqa.suse.de as of $(date --iso-8601='seconds'):\n" && \
 echo "$email_report" && \
 echo -e "\nAny feedback regarding the script processing or contact can be communicated using issues on the github repo or directly to okurz@suse.de\n\nRegards,\nYour openqa_review") | mutt -s 'Daily status from https://openqa.suse.de' -e 'my_hdr From: openqa-review <okurz@suse.de>' $recv

html_report="$(${openqa_review} $openqa_review_args $openqa_review_html_args | decrease_header | markdown)"
html_report_closed="$(${openqa_review} $openqa_review_args $load_args -f closed | decrease_header | markdown)"
html_report_unassigned="$(${openqa_review} $openqa_review_args $load_args -f unassigned | decrease_header | markdown)"

TPL_OPENQA_HEADER_LINKS=$(cat <<EOF
$(header_line "complete_report_box" "Complete report")
$(header_line "closed_box" "Closed bugs")
$(header_line "unassigned_box" "Unassigned bugs")
EOF
)

TPL_OPENQA_CONTENT=$(cat <<EOF
$(entry_block "complete_report_box" "Complete report" "${html_report}")
$(entry_block "closed_box" "Closed bugs" "${html_report_closed}")
$(entry_block "unassigned_box" "Unassigned bugs" "${html_report_unassigned}")
EOF
)

eval "cat <<EOF
$(<$TPL)
EOF
" > ${html_target}

${openqa_review} $openqa_review_args $openqa_review_reminder_args > /dev/null
