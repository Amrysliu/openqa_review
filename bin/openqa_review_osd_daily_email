#!/bin/sh -e

. $(dirname $0)/_common
setup_tmpdir

recv="${recv:-"openqa-suse-status@suse.de"}"
html_target="${html_target:-"/suse/okurz/Export/openqa_suse_de_status.html"}"
openqa_review_args="${openqa_review_args:-"--host http://openqa.suse.de -n -r -T --query-issue-status --no-empty-sections --include-softfails --running-threshold=2"}"
openqa_review_email_args="${openqa_review_email_args:-""}"
openqa_review_html_args="${openqa_review_html_args:-"--report-links"}"
openqa_review_save_args="${openqa_review_save_args:-"--report-links --save --save-dir ${tmp}"}"
openqa_review="${openqa_review:-"$(which openqa-review)"}"
# the awk call is to ignore the "InsecureWarning" and the following blank line
# that is generated by accessing with requests on an https server for which we
# don't know the certificate, see http://unix.stackexchange.com/a/279620
# this is actually fixed in a more recent python3-requests but we don't have
# that yet. Anyway, we don't need certificates as we trust the internal server
# and as long as we don't want to authenticate manually against the UI it's ok
# to use the http:// URL
#save_report="$(${openqa_review} $openqa_review_args $openqa_review_save_args 2>&1| awk -v nlines=2 '/Insecure.*Warning/ {for (i=0; i<nlines; i++) {getline}; next} 1')"
save_report="$(${openqa_review} $openqa_review_args $openqa_review_save_args 2>&1)"
email_report="$(${openqa_review} $openqa_review_args $openqa_review_email_args)"
(echo -e "This is an automated message generated by 'openqa-review', see https://github.com/okurz/openqa_review for details. An HTML version of this report is available on https://w3.nue.suse.com/~okurz/openqa_suse_de_status.html. Status of tests and builds on https://openqa.suse.de as of $(date --iso-8601='seconds'):\n" && \
 echo "$email_report" && \
 echo -e "\nAny feedback regarding the script processing or contact can be communicated using issues on the github repo or directly to okurz@suse.de\n\nRegards,\nYour openqa_review") | mutt -s 'Daily status from https://openqa.suse.de' -e 'my_hdr From: openqa-review <okurz@suse.de>' $recv

html_report="$(${openqa_review} $openqa_review_args $openqa_review_html_args)"
echo "$html_report" | markdown > ${html_target}
